# Git Integration Guide

Version-controlled SDR snapshots for audit trails, change tracking, and team collaboration.

## Overview

The Git integration feature allows you to automatically save SDR snapshots in a Git-friendly format and commit them to a repository. This provides:

- **Audit Trail**: Full history of every data view configuration change
- **Change Detection**: Use `git diff` to see exactly what changed between snapshots
- **Team Collaboration**: Share snapshots via Git repositories (GitHub, GitLab, etc.)
- **PR-Based Review**: Review configuration changes through pull requests
- **Compliance**: Evidence of configuration state at any point in time

## Prerequisites

- **Git installed**: Ensure Git is in your PATH
  ```bash
  git --version
  ```
- **Git identity configured**: Required for commits
  ```bash
  git config --global user.name "Your Name"
  git config --global user.email "you@example.com"
  ```

## Quick Start

```bash
# 1. Initialize a Git repository for snapshots
cja_auto_sdr --git-init --git-dir ./sdr-snapshots

# 2. Generate SDR and commit to Git
cja_auto_sdr dv_12345 --git-commit

# 3. View history
cd sdr-snapshots && git log --oneline
```

## CLI Options

| Option | Description | Default |
|--------|-------------|---------|
| `--git-init` | Initialize a new Git repository for snapshots | - |
| `--git-commit` | Save snapshot and commit to Git | - |
| `--git-push` | Push to remote after committing | - |
| `--git-message MSG` | Custom commit message | Auto-generated |
| `--git-dir DIR` | Directory for Git snapshots | `./sdr-snapshots` |

## Snapshot Format

Snapshots are saved in a Git-friendly format with separate JSON files for easy diffing:

```
sdr-snapshots/
├── .git/
├── .gitignore
├── README.md
└── ProductionAnalytics_dv_12345/
    ├── metrics.json      # All metrics, sorted by ID
    ├── dimensions.json   # All dimensions, sorted by ID
    └── metadata.json     # Data view info and quality summary
```

### Why Separate Files?

- **Targeted Diffs**: See exactly which metrics or dimensions changed
- **Smaller Diffs**: Changes to metrics don't show up in dimensions diff
- **Sorted by ID**: Consistent ordering means minimal noise in diffs
- **Human Readable**: JSON with indentation for easy inspection

### File Contents

**metrics.json**
```json
[
  {
    "id": "cm_revenue",
    "name": "Revenue",
    "type": "currency",
    "description": "Total revenue in USD"
  },
  {
    "id": "cm_sessions",
    "name": "Sessions",
    "type": "integer"
  }
]
```

**dimensions.json**
```json
[
  {
    "id": "dim_browser",
    "name": "Browser",
    "type": "string"
  },
  {
    "id": "dim_country",
    "name": "Country",
    "type": "string"
  }
]
```

**metadata.json**
```json
{
  "snapshot_version": "1.0",
  "created_at": "2026-01-19T10:30:00.000000",
  "data_view_id": "dv_12345",
  "data_view_name": "Production Analytics",
  "owner": "analytics-team",
  "description": "Main production data view",
  "tool_version": "3.0.12",
  "summary": {
    "metrics_count": 145,
    "dimensions_count": 287,
    "total_components": 432
  },
  "quality": {
    "total_issues": 3,
    "by_severity": {
      "HIGH": 1,
      "MEDIUM": 2
    }
  }
}
```

## Auto-Generated Commit Messages

When you use `--git-commit` without `--git-message`, a descriptive commit message is automatically generated:

```
[dv_12345] SDR snapshot 2026-01-19 10:30

Data View: Production Analytics
ID: dv_12345
Components: 145 metrics, 287 dimensions

Quality:
  HIGH: 1
  MEDIUM: 2

Generated by CJA SDR Generator v3.0.12
```

With a custom message (`--git-message "Weekly sync"`):

```
[dv_12345] Weekly sync

Data View: Production Analytics
ID: dv_12345
Components: 145 metrics, 287 dimensions

Generated by CJA SDR Generator v3.0.12
```

## Usage Examples

### Basic Workflow

```bash
# Initialize repository (one-time setup)
cja_auto_sdr --git-init

# Generate and commit
cja_auto_sdr dv_12345 --git-commit

# Generate with custom message
cja_auto_sdr dv_12345 --git-commit --git-message "Pre-release snapshot"

# Generate, commit, and push
cja_auto_sdr dv_12345 --git-commit --git-push
```

### Multiple Data Views

```bash
# Process multiple data views sequentially
for dv in dv_prod dv_staging dv_dev; do
  cja_auto_sdr $dv --git-commit --git-message "Weekly audit"
done

# Or use batch mode (commits after each)
cja_auto_sdr dv_prod dv_staging dv_dev --git-commit
```

### Custom Directory

```bash
# Use a different directory
cja_auto_sdr dv_12345 --git-commit --git-dir ./my-snapshots

# Initialize custom directory first
cja_auto_sdr --git-init --git-dir /path/to/shared/snapshots
```

### CI/CD Integration

```yaml
# GitHub Actions example
name: Weekly SDR Snapshot
on:
  schedule:
    - cron: '0 9 * * 1'  # Monday 9 AM

jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: pip install .

      - name: Generate SDR snapshot
        env:
          ORG_ID: ${{ secrets.ORG_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          SECRET: ${{ secrets.SECRET }}
          SCOPES: openid, AdobeID, additional_info.projectedProductContext
        run: |
          cja_auto_sdr dv_prod \
            --git-commit \
            --git-message "Weekly snapshot $(date +%Y-%m-%d)" \
            --git-dir ./sdr-snapshots

      - name: Push changes
        run: |
          cd sdr-snapshots
          git push
```

## Working with Git History

### View History

```bash
cd sdr-snapshots

# View commit history
git log --oneline

# View history for specific data view
git log --oneline -- ProductionAnalytics_dv_12345/

# View commits with stats
git log --stat
```

### Compare Versions

```bash
# Compare last two snapshots
git diff HEAD~1 HEAD -- ProductionAnalytics_dv_12345/metrics.json

# Compare specific commits
git diff abc123 def456 -- ProductionAnalytics_dv_12345/

# Show what changed in a commit
git show abc123 --stat
```

### View Changes Over Time

```bash
# See who changed what
git blame ProductionAnalytics_dv_12345/metrics.json

# Find when a metric was added
git log -p --all -S 'cm_revenue' -- '*/metrics.json'

# Show history of a specific file
git log -p -- ProductionAnalytics_dv_12345/metadata.json
```

### Restore Previous State

```bash
# View old version without changing current
git show HEAD~5:ProductionAnalytics_dv_12345/metrics.json

# Checkout old version to inspect
git checkout HEAD~5 -- ProductionAnalytics_dv_12345/
git diff  # See what's different

# Restore current version
git checkout HEAD -- ProductionAnalytics_dv_12345/
```

## Team Collaboration

### Setting Up a Shared Repository

```bash
# Initialize local repository
cja_auto_sdr --git-init --git-dir ./sdr-snapshots

# Add remote
cd sdr-snapshots
git remote add origin git@github.com:brian-a-au/cja-snapshots.git

# Push initial commit
git push -u origin main
```

### PR-Based Workflow

```bash
# Create feature branch for changes
cd sdr-snapshots
git checkout -b weekly-audit-2026-01-19

# Generate snapshot
cd ..
cja_auto_sdr dv_prod --git-commit --git-dir ./sdr-snapshots

# Push and create PR
cd sdr-snapshots
git push -u origin weekly-audit-2026-01-19

# Create PR via GitHub CLI
gh pr create --title "Weekly SDR Audit 2026-01-19" --body "Automated weekly snapshot"
```

### Review Changes in GitHub/GitLab

When you open a PR, reviewers can see:
- Which metrics/dimensions were added, removed, or modified
- Changes to metadata (owner, description, etc.)
- Quality issue counts

## Best Practices

### 1. Use Meaningful Commit Messages

```bash
# Good: Descriptive and actionable
cja_auto_sdr dv_prod --git-commit --git-message "Add Q1 revenue metrics"
cja_auto_sdr dv_prod --git-commit --git-message "Fix duplicate dimension names"
cja_auto_sdr dv_prod --git-commit --git-message "Pre-release audit for v2.0"

# Avoid: Generic messages
cja_auto_sdr dv_prod --git-commit --git-message "Update"
```

### 2. Regular Snapshots

Schedule regular snapshots to build history:

```bash
# Cron job for daily snapshots
0 6 * * * /path/to/cja_auto_sdr dv_prod --git-commit --git-dir /snapshots --quiet
```

### 3. Organize by Environment

```
sdr-snapshots/
├── Production_dv_prod/
├── Staging_dv_staging/
└── Development_dv_dev/
```

### 4. Use Branches for Major Changes

```bash
# Before major migration
git checkout -b pre-migration-baseline
cja_auto_sdr dv_prod --git-commit --git-message "Baseline before migration"
git push -u origin pre-migration-baseline

# After migration
git checkout main
cja_auto_sdr dv_prod --git-commit --git-message "Post-migration state"

# Compare branches
git diff pre-migration-baseline main
```

### 5. Retention Policy

For long-running repositories, consider:

```bash
# Keep only recent history (squash old commits)
git rebase -i HEAD~100

# Or use shallow clones for CI
git clone --depth 10 git@github.com:brian-a-au/cja-snapshots.git
```

## Troubleshooting

### "Not a Git repository"

```bash
# Initialize the repository first
cja_auto_sdr --git-init --git-dir ./sdr-snapshots

# Or initialize manually
mkdir -p sdr-snapshots && cd sdr-snapshots && git init
```

### "Git not found"

Ensure Git is installed and in your PATH:

```bash
# Check Git installation
git --version

# Install Git (macOS)
brew install git

# Install Git (Ubuntu)
sudo apt-get install git

# Install Git (Windows) - choose one:
winget install --id Git.Git -e --source winget   # Windows Package Manager
# Or download from: https://git-scm.com/download/win
```

### "Push failed"

```bash
# Check remote configuration
cd sdr-snapshots && git remote -v

# Add remote if missing
git remote add origin git@github.com:brian-a-au/cja-snapshots.git

# Check authentication
ssh -T git@github.com
```

### "No changes to commit"

This means the snapshot is identical to the previous one. The data view configuration hasn't changed since the last commit. This is normal and expected behavior.

## Integration with Other Features

### Combined with --diff

```bash
# Compare data views and commit snapshots
cja_auto_sdr --diff dv_prod dv_staging --auto-snapshot --git-commit
```

### Combined with Batch Processing

```bash
# Process multiple data views with Git commits
cja_auto_sdr dv_1 dv_2 dv_3 --batch --git-commit
```

### Combined with Different Output Formats

```bash
# Generate Excel AND commit Git snapshot
cja_auto_sdr dv_prod --format excel --git-commit
```

## Limitations

1. **Read-Only**: Git integration provides audit/tracking capabilities only. This tool reads from CJA and saves snapshots locally—it cannot push changes back to CJA. Any configuration changes must be made directly in the CJA UI.

2. **Timestamp Changes**: The `metadata.json` file includes a `created_at` timestamp that changes with each snapshot. This means a new commit will be created even if metrics/dimensions are unchanged. The actual component files (`metrics.json`, `dimensions.json`) will show no diff if unchanged.

3. **Large Repositories**: For data views with thousands of components, the JSON files can be large. Consider using Git LFS for very large repositories.

## See Also

- [Configuration Guide](CONFIGURATION.md) - Environment variables for CI/CD pipelines
- [Diff Comparison Guide](DIFF_COMPARISON.md) - Compare data views and track changes
- [CLI Reference](CLI_REFERENCE.md) - Complete command-line reference
- [Batch Processing Guide](BATCH_PROCESSING_GUIDE.md) - Process multiple data views
